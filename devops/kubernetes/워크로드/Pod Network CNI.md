# Pod Network CNI

해당 블로그 글을 참고하여 작성하였다. https://kubevious.io/blog/post/comparing-kubernetes-container-network-interface-cni-providers

벤치마크 결과도 있다. https://itnext.io/benchmark-results-of-kubernetes-network-plugins-cni-over-10gbit-s-network-36475925a560

## CNI

CNI는 GO로 작성된 사양과 라이브러리의 그룹을 통해 네트워킹 자원을 동적으로 구성할 수 있도록 하는 네트워크 프레임워크이다. 플러그인에 대해 언급된 사양은 네트워크를 구성하고 IP 주소를 생성하고 다중 호스트 연결을 유지하는 인터페이스를 간략하게 설명한다. 

쿠버네티스 컨텍스트에서는 CNI는 kubelet과 원활하게 통합되어 언더레이 또는 오버레이 네트워크를 사용하는 파드들 사이의 자동 네트워크 구성을 허용한다. 언더레이 네트워크는 라우터와 스위치로 구성된 네트워크 레이어의 물리적 레벨에서 정의된다. 반대로, 오버레이 네트워크는 네트워크 트래픽을 캡슐화 하기 위해 VxLan과 같은 가상 네트워크를 사용한다.

네트워크 구성 타입이 지정되면, 런타임은 컨테이너가 조인할 네트워크를 정의하고 네트워크 인터페이스를 컨테이너 네임스페이스에 추가하기 위해 CNI 플러그인을 호출한다. 그리고 연결된 서브네트워크를 할당하고 IPAM 플러그인을 호출하여 라우트한다.

쿠버네티스 네트워킹 외에도, CNI는 OpenShift와 같은 쿠버네티스 기반 플랫폼을 지원하여 SDN 접근 방식을 통해 클러스터 전체에 통합 컨테이너 통신을 제공한다.



이 블로그에서는 여러 CNI wnd Flannel과, Calico, VeaveNet, Cilium, Canal을 비교하였다.



### Flannel

---

Flannel은 필수 쿠버네티스 네트워크 구성 및 관리 사용 사례를 다루기 위해 배포할 수 있는 사용하기 쉬운 (`easy-to-use`) 네트워크 모델을 제공한다.

Flannel은 내부 IP 주소 할당을 위해 각 쿠버네티스 클러스터 노드에 서브넷을 할당하는 오버레이 네트워크의 구성에 의해 구동된다. flanneld라 불리는 데몬 에이전트가 서브넷을 임대하고 관리한다. flanneld는 쿠버네티스 클러스터 및 배포판에서 쉽게 설치라고 구성하기 위해 단일 바이너리로 패키징된다. 

IP 주소가 할당한 후 Flannel은 쿠버네티스, etcd 클러스터 또는 API를 활용하여 호스트 매핑과 다른 네트워크 관련 구성을 저장하고 캡슐화된 패킷을 통해 호스트/노드 사이의 통신을 유지한다.

기본적으로, Flannel은 캡슐화와 통신을 위해 VXLAN 구성을 사용한다. 그러나 host-gw, UDP와 같은 여러 유형의 백엔드를 사용할 수 있다. Flannel을 사용하면 여러 호스트가 동일한 네트워크에 있을 때 필요한 라우팅을 위해 VxLAN-GBP를 활성화 할 수도 있다.

Flannel은 기본적으로 캡슐화된 트래픽의 암호화를 위한 어떠한 메커니즘도 구현하지 않는다. 그래도 쿠버네티스 클러스터의 워커 노드 간에 암호회된 터널을 설정할 수 있는 IPsec 암호화를 지원한다.

Flannel은 클러스터 관리자 관점에서 쿠버네티스 CNI 사용을 시작하려는 초보자를 위한 좋은 CNI 플러그인이다. Flannel의 간단한 네트워킹 모델은 호스트 간의 트래픽 전송을 제어하는 데 사용될 때 까지 단점은 없다.



**장점**

* IPsec 암호화 지원
* 단일 바이너리 설치와 구성

**단점**

* 네트워크 정책 지원 안함 (ACL 지원 X)
* 여러 호스트를 실행하지 않고 단일 데몬을 통해 다중 네트워크를 실행하면서 각 호스트에 대해 여러 데몬을 실행하는 것이 가능하다.





### Calico

---

Calico는 네트워크 성능, 유연성 및 전력과 같은 요소가 필수적인 환경에 적합하다. Flannel과 달리, Calico는 고급 네트워크 관리 보안 능력을 제공하는 동시에 호스트와 파드 간의 연결에 대한 전체적인 개요를 제공한다.

표준 쿠버네티스 클러스터에서, Calico는 각 노드에서 데몬셋으로 쉽게 배포될 수 있다. 클러스터의 각 노드는 여러 네트워크 업무를 관리하기 위해 3개의 Calico 컴포넌트가 설치된다. (Felix, BIRD, confd) Calico 에이전트로써 작동하는 Felix는 BIRD 및 confd가 라우팅 구성 변경을 관리하는 노드 라우팅을 처리한다. 

노드 간의 라우팅 패킷에 대해, Calico는 오버레이 네트워크 대신 BGP 라우팅 프로토콜을 사용한다. 오버레이 네트워킹 모드는 오버레이 네트워크와 같이 서브넷을 통해 전송되는 패킷을 캡슐화 할 수 있는 IP-IN-IP 또는 VXLAN을 통해 사용 가능하다. 

Calico를 사용하면 패킷을 조작하는 래퍼가 없으므로 추적(Tracing)과 디버깅이 다른 CNI에 비해 쉽다. 개발자와 관리자는 패킷 행동을 쉽게 이해할 수 있고 정책 관리 및 액세스 제어 목록과 같은 고급 네트워크 피처를 사용할 수 있다.

Calico에서의 네트워크 정책은 파드에 수신 정책을 할당하기 위해 매니페스트를 통해 적용할 수 있는 deny/match rule을 구현한다. 사용자는 전역 범위의 정책을 정의하고 Istio 서비스 메쉬와 통합하여 파드 트래픽을 제어하고 보안을 개선하며 쿠버네티스 워크로드를 제어할 수 있다.

전반적으로, Calico는 네트워크 컴포넌트를 제어하기를 원하는 사용자에게 좋은 선택이다. Calico는 kops, Kubespray와 같은 다양한 쿠버네티스 플랫폼에서도 사용하기 쉽고 Calico Enterprise를 통해 상업적인 지원도 제공한다.



**장점**

* 네트워크 정책 지원
* 높은 네트워크 성능
* SCTP 지원

**단점**

* 멀티캐스트 지원 안함



### Cilium

---

Cilium은 eBPF 필터링 기술을 활용한 높은 수준의 애플리케이션 규칙을 추가하여 쿠버네티스 서비스 사이의 네트워크 연결을 보호한다. Cilium은 쿠버네티스 클러스터의 각 노드에 `cilium-agent` 데몬으로 배포되어 운영을 관리하고 네트워크 정의를 eBPF 프로그램으로 변환한다. 

파드 사이의 통신은 오버레이 네트워크 또는 라우팅 프로토콜을 사용하여 발생한다. IPv4와 IPv6 모두 지원한다. 오버레이 네트워크 구현은 패킷 캡슐화를 위해 VXLAN 터널링을 활용한다. 반면에 네이티브 라우팅은 캡슐화되지 않은 BGP 프로토콜을 통해 발생한다.

Cilium은 다중 쿠버네티스 클러스터와 함께 사용할 수 있고 모든 클러스터에서 다중 CNI 기능과 높은 수준의 검사, 그리고 파드간 연결을 제공할 수 있다.

이 네트워크 및 애플리케이션 레이어 인식은 패킷 검사를 관리하고 애플리케이션 프로토콜 패킷을 사용한다.

Cilium은 HTTP 요청 필터를 통해 쿠버네티스 네트워크 정책을 지원한다. 정책 설정은 YAML이나 Json 형식의 파일로 작성할 수 있고 ingress(들어오는 요청)와 egress(나가는 요청) 집행을 모두 제공한다. 관리자는 Istio와 같은 서비스 메쉬와 정책을 통합하면서 reguest method 또는 path header를 기반으로 요청을 수락하거나 거절할 수 있다.



**장점**

* 다중 클러스터 지원
* 다른 CNI와 함께 사용 가능

**단점**

* BGP를 위해 다른 CNI와 페어링해야 할 수 있다
* 다중 클러스터를 위한 설치가 복잡하다.



### WeaveNet

---

WeaveNet은 쿠버네티스 클러스터에서 유연한 네트워킹을 허용하는 CNI 지원 네트워킹 솔루션이다. WeaveNet은 처음에는 컨테이너를 위해 개발되었지만 추후에 쿠버네티스 네트워크 플러그인으로 진화되었다. WeaveNet은 각 노드에 필요한 네트워킹 구성요소를 설치하는 데몬셋으로  쿠버네티스 클러스터에 쉽게 설치하고 구성할 수 있다.

WeaveNet은 클러스터의 모든 노드와 연결하는 메쉬 오버레이 네트워크를 생성함으로써 작동한다. 네트워크 내부에서, WeaveNet은 노드 간의 패킷 전송을 위해 커널 시스템을 활용한다. 커널에서 활용되는 프로토콜은 userspace를 여러 번 왔다갔다 하지 않고 패킷을 대상 파드로 바로 전송하는 빠른 데이터 경로로 알려져있다. 

빠른 데이터 경로가 작동하지 않거나 패킷이 다른 호스트로 가야하는 경우 WeaveNet은 패킷 전송을 위해 slow sleeve protocol을 사용한다. 호스트네임 확인, 로드밸런시으 fault tolerance와 같은 기능이 WeaveDns라고 불리는 Weavenet DNS 서버를 통해 제공된다.

패킷 캡슐화와 암호화를 위해, WeaveNet은 쿠버네티스용 VxLAN을 사용하고 빠른 데이터 경로 및 sleeve traffic을 위해 NaCl와 IPsec 암호화를 사용한다.

WeaveNet은 네트워크 설정을 저장하기 위해 etcd를 사용하지 않는다. 설정은 데몬셋에 의해 생성된 각 파드에서 공유되는 데이터베이스 파일에 유지된다.

네트워크 정책 지원이 따라오면서, WeaveNet은 쿠버네티스 네트워크 정책을 관리하기 위해 weave-npc 컨테이너를 사용한다. 컨테이너는 기본적으로 설치되고 구성되며 호스트 간의 통신을 보호하기 위한 규칙만 필요하다.



**장점**

* 커널 레벨의 통신
* 네트워크 정책과 암호화 제공
* 문제 해결에 대한 유료 지원 제공

**단점**

* 커널 기반 라우팅 때문에 리눅스만 지원
* 기본 암호화 표준으로 인한 네트워크 속도 감소



### Canal

---

Canal은 Flannel과 Calico 네트워킹 능력을 결합하여 쿠버네티스 클러스터에게 통합 네트워킹 솔루션을 제공하는 CNI 프로바이더이다. Canal은 Flannel 오버레이 네트워크와 VXLAN 캡슐화를 Felix, host agent, network policy와 같은 Calico의 네트워크 컴포넌트와 통합한다. 전반적으로 Canal은 보다 엄격한 보안을 위해 네트워크 정책 규칙과 함께 오버레이 네트워킹 모델을 활용하려는 조직에 탁월한 선택이다.

**장점**

* Flannel 오버레이 네트워크를 사용한 네트워크 정책 지원
* Flannel 및 Calico를 배포하는 통합 방법 제공

**단점**

* 두 프로젝트 간의 깊은 통합이 그리 많지 않음



















