# MetalLB

MetalLB는 클라우드 프로바이더를 지원하지 않는 쿠버네티스 클러스터 환경을 위한 네트워크 로드밸런서 구현체를 제공한다. 그래서 MetalLB를 사용하면 모든 클러스터 내에서 로드밸런서 서비스를 효과적으로 사용할 수 있다.

MetalLB는 해당 서비스를 제공하기 위해 두 가지 기능인 **주소 할당** 과 **외부 알림** 을 작동한다.



## 주소 할당

클라이언트 프로바이더에서의 클러스터에서는, 로드밸런서를 요청하면 클라우드 플랫폼은 IP 주소를 할당해준다. 베어메탈 환경에서는 MetalLB가 IP 주소 할당 역할을 맡는다.

MetalLB는 외부에서 IP 주소를 생성할 수 없기 때문에, 사용할 수 있는 IP 주소 풀을 제공해야 한다. MetalLB는 서비스가 들어오고 나갈 때 개별 주소 할당과 해지를 처리하지만 구성된 풀의 일부 IP만  다룬다.

MetalLB의 IP 주소 풀을 얻는 방법은 환경에 따라 다르다. Colocation 환경에서 베어메탈 클러스터를 실행하는 경우, 호스팅 제공업체가 임대용 IP 주소를 제공할 수 있다. 이러한 경우, IP 공간의 `/26` 을 임대하고 클러스터 서비스를 위해 해당 범위를 MetalLB에 제공한다. 

또는 클러스터가 완전히 비공개일 수도 있으며 가까운 LAN에 서비스를 제공하지만 인터넷에는 노출되지 않을 수도 있다. 이런 경우에는 개인 주소 공간 중 하나에서 IP 범위를 선택하고 이를 MetalLB에 할당할 수 있다. 



## 외부 알림

MetalLB가 서비스에 외부 IP를 할당한 후 IP가 클러스터에 존재한다는 것을 클러스터 외부의 네트워크가 인식하도록 해야한다. MetalLB는 이를 해결하기 위해 표준 라우팅 프로토콜(ARP, NDP, BGP)을 사용한다.



## Layer 2 mode (ARP / NDP)

Layer 2 Mode에서는 하나의 노드가 로컬 네트워크에 서비스를 알리는 책임을 가진다. 네트워크의 관점에서 봤을 때 단순히 그 머신에 네트워크 인터페이스에 할당된 여러 IP 주소가 있는 것 처럼 보인다. 

내부적으로 MetalLB는 IPv4 서비스에 대한 ARP 요청과 IPv6에 대한 NDP 요청에 응답한다.

Layer 2 mode의 주요 장점은 보편성이다. 이는 특별한 하드웨어나 라우터 없이 모든 이더넷 네트워크에서 작동한다.



### 로드밸런싱

Layer 2 mode에서 서비스 IP에 대한 모든 트래픽은 하나의 노드로 향한다. 여기서 `kube-proxy`는 트래픽을 모든 서비스의 파드로 분산시킨다.

이러한 점에서, Layer 2는 로드밸런서를 구현하지 않는다. 그 대신에 failover 메커니즘을 구현한다. 그래서 현재 리더노드가 어떠한 이유로 실패하면 다른 노드가 인계받을 수 있다. 리더노드가 어떠한 이유로 실패한다면 failover가 자동으로 일어난다. 실패한 노드는 `memberlist` 를 사용하여 감지되며 그 시점에서 새로운 노드가 실패한 노드의 IP 주소 소유권을 인수한다.



### 외부 알림

클러스터 내 하나의 머신이 서비스의 소유권을 가지고 로컬 네트워크에서 해당 IP에 연결할 수 있도록 표준 주소 검색 프로토콜 (ARP, NDP)를 사용한다. LAN의 관점에서, 외부 알림을 하는 머신은 여러 개의 IP 주소를 가지고 있다.



### 한계

Layer 2 mode는 크게 두 가지 한계점이 있다. 하나는 **단일 노드 병목현상** 이고, 나머지 하나는 **잠재적으로 failover가 느리다** 는 점이다.

Layer 2 mode에서는 하나의 리더로 선출된 노드는 서비스 IP에 대한 모든 트래픽을 수신한다. 이는 서비스의 인그레스 대역폭이 단일 노드의 대역폭으로 제한된다는 의미이다. 이는 ARP 및 NDP를 사용하여 트래픽을 조정하는 데 있어서 근본적인 한계를 가진다.

현재 구현에서는, 노드 간 failover는 클라이언트 상호 협력에 의존한다. failover가 발생할 때 MetalLB는 서비스 IP와 관련된 MAC 주소가 변경되었음을 클라이언트를 알리기 위해 여러 개의 'unsolicited' Layer 2 패킷을 보낸다. 대부분의 OS는 해당 패킷을 올바르게 처리하며 인접 캐시를 즉시 업데이트한다. 이러한 경우 failover는 몇 초 내에 발생한다. 하지만, 일부 시스템은 해당 패킷을 처리하는 구현을 하지 않거나 캐시 업데이트를 지연시키는 버그가 있는 구현을 할 수도 있다.

메이저 OS의 최신 버전들은 Layer 2 failover에 대한 구현을 올바르게 했기 때문에 문제가 발생하는 상황은 최신 OS가 아닌 상황에서 발생할 것이다.

계획된 failover가 버그 클라이언트에 미치는 영향을 최소화하기 위해서는 리더쉽을 뒤집은 후 몇 분 동안은 이전 리더노드를 유지해야 캐시가 새로 고쳐질 때 까지 이전 클라이언트에 대한 트래픽을 계속 전달할 수 있다.

계획되지 않은 failover인 경우, 버그 클라이언트가 캐시 엔트리를 리프레쉬할 때 까지는 서비스 IP에 연결할 수 없다.







## BGP mode

BGP 모드에서는 클러스터 내 각 노드는 네트워크 라우터와 함께 BGP 피어링 세션을 수립하고 외부 클러스터 서비스의 IP를 알리기 위해 피어링 세션을 사용한다.

라우터가 다중 경로를 지원하도록 구성되어있다고 가정하면, 이는 실제 로드밸런싱을 가능하게 한다. MetalLB에 의해 퍼블리싱된 경로는 nexthop을 제외하고는 서로 동일하다. 이는 라우터가 모든 nexthop을 함께 사용하고 이들 사이의 로드밸런싱을 한다는 의미이다.

패킷이 노드에 도착한 후, `kube-proxy`는 서비스의 특정 파드로 패킷을 가져오기 위해 트래픽 라우팅의 최종 홉을 담당한다. 



### 로드밸런싱

실제 로드밸런싱의 정확한 동작은 특정 라우터 모델과 구성에 따라 다르다. 하지만, 일반적인 동작은 패킷 해쉬 기반으로 연결당 균형(*Per-Connection*) 을 유지하는 것이다. 

*Per-Connection* 은 단일 TCP/UDP 세션에 대한 모든 패킷이 클러스터 내 하나의 머신으로 전달된다는 의미이다. 트래픽 분산은 한 연결 내 패킷이 아닌 서로 다른 연결 사이에서만 발생한다.

여러 클러스터 노드에 패킷을 분산하면 여러 수준에서 잘못된 동작이 발생하기 때문에 **클러스터 내 하나의 머신으로 전달** 되는 것은 좋다.

* 단일 연결을 여러 경로에 분산하면 유선에서 패킷 재정렬이 발생한다. 이는 최종 호스트의 성능에 큰 영향을 미친다.
* 쿠버네티스의 노드 내 트래픽 라우팅은 노드 간에 일관성이 보장되지 않는다. 이는 두 개의 다른 노드가 동일한 연결에 대한 패킷을 다른 파드로 라우팅하기로 결정할 수 있음을 의미한다. 이는 커넥션 실패로 이어질 수도 있다.



패킷 해싱은 고성능 라우터가 상태를 유지하지 않고 여러 백엔드에 연결을 분산시키는 방법이다. 각 패킷에 대하여 라우터는 몇 가지 필드를 추출하고 이를 `seed` 로 사용하여 가능한 백엔드 중 하나를 결정적으로 선택한다. 만약 모든 필드가 같다면, 동일한 백엔드가 선택될 것이다.

사용 가능한 정확안 해싱 방법은 라우터 하드웨어 및 소프트웨어에 따라 다르다. *3-tuple*과 *5-tuple* 해싱이라는 두 가지 옵션이 있다. 

**3-tuple** 은 key 로써  `(protocol, source-ip, dest-ip)` 라는 튜플을 사용한다. 이는 두 개의 유일한 IP 사이의 모든 패킷들은 동일한 백엔드로 전달될 것이라는 의미를 가진다. 

**5-tuple** 은 3-tuple에서 `source-port`, `dest-port` 를 추가하여 백엔드를 결정한다.



### 한계점

로드밸런싱 메커니즘으로 BGP를 사용하는 것은 맞춤형 로드밸런서 대신 표준 라우터 하드웨어를 사용할 수 있다는 장점이 있다. 하지만 단점도 있다.

가장 큰 단점은 BGP 기반 로드밸런싱은 주소에 대해 설정된 백엔드의 변경사항에 정상적으로 반응하지 않는다는 것이다. 이는 클러스터 노드가 다운되면 서비스에 대한 모든 활성 연결이 끊어질 것으로 예상해야 한다는 것을 의미한다.

BGP 기반 라우터는 상태를 유지하지 않는 로드밸런싱을 구현한다. 해당 라우터는 주어진 패킷을 패킷 헤더에 있는 일부 필드를 해싱하고 해당 해시를 사용 가능한 백엔드 배열에 대한 인덱스로 사용하여 특정 다음 홉을 할당한다. 여기서 문제점은 라우터 내에서 사용되는 해시는 일반적으로 안정적이지 않다. 그래서 백엔드 셋의 크기가 변할 때 마다 기존 연결은 효율적으로 무작위로 다시 해싱될 것이며 이는 기존 커넥션의 대부분은 다른 백엔드로 갑자기 전달되는데 백엔드는 해당 연결에 대해 전혀 알지 못한다는 것을 의미한다.













## 설치



### Requirement

* Kubernetes 1.3+, 아직 네트워크 로드밸런싱 기능이 없는 클러스터
* MetalLB와 공존할 수 있는 클러스터 네트워크 구성
* MetalLB가 배포할 일부 IPv4 주소
* BGP 모드일 경우, BGP를 사용할 수 있는 하나 이상의 라우터가 필요
* 7946(TCP&UDP)번으로 오는 트래픽이 노드들 사이에 모두 허용되어야 한다.



### Preparation

IPVS 모드에서 kube-proxy를 사용하고 있다면, 버전 1.14.2부터 strict ARP mode를 활성화해야 한다.

```shell
$ kubectl edit configmap -n kube-system kube-proxy
```

설정을 다음과 같이 변경하자.

```yaml
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
mode: "ipvs"
ipvs:
  strictARP: true
```



### Manifest로 설치하기

```shell
$ kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.11.0/manifests/namespace.yaml
$ kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.11.0/manifests/metallb.yaml
```

이 manifest로 생성되는 객체들은 모두 `metallb-system` 네임스페이스로 배포될 것이다.

* `metallb-system/controller` 디플로이먼트는 IP 주소 할당을 처리하는 클러스터 전체 컨트롤러이다.
* `metallb-system/speaker` 데몬셋은 서비스에 도달할 수 있도록 선택한 프로토콜을 말하는 구성요소이다.
* 컨트롤러와 스피커를 위한 서비스 어카운트는 컴포넌트가 작동하는 데 필요한 RBAC 권한과 함께한다.



Helm과 Kustomize로도 설치가 가능하다. https://metallb.universe.tf/installation/



## 구성

MetalLB는 구성하기 전 까지는 idel 상태로 남는다. 그래서 MetalLB를 사용하기 위해서는 별도로 구성을 해야한다.



구성하는 방법은 크게 3가지가 있다. 이는 서비스 IP를 알리는 데 사용할 프로토콜에 따라 다르다.

* Layer 2 Configuration

* BGP Configuration

* Advanced Configuration

  

### Layer 2 Configuration

Layer 2 mode는 구성하기 가장 간단한 방식이다. 대부분의 경우에는 프로토콜 별 구성이 필요하지 않고 IP 주소만 필요하다.

Layer 2 mode는 워커노드의 네트워크 인터페이스를 바인딩할 필요가 없다. 이는 로컬 네트워크의 ARP 요청에 직접 응답하여 컴퓨터의 MAC주소를 클라이언트에 제공하는 방식으로 적절하다.

예를 들어, 아래 구성은 MetalLB가 `192.168.1.240`에서 `192.168.1.250`까지의 IP에 대한 제어를 제공하고 Layer 2 모드를 구성한다.

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: metallb-system
  name: config
data:
  config: |
    address-pools:
    - name: default
      protocol: layer2
      addresses:
      - 192.168.1.240-192.168.1.250
```



### BGP Configuration

하나의 BGP 라우터와 하나의 IP주소 범위를 포함하는 기본 구성의 경우 4가지 정보가 필요하다.

* MetalLB가 연결해야하는 라우터 IP 주소
* 라우터의 AS 번호
* MetalLB가 사용할 AS번호
* CIDR 프리픽스로 노출되는 IP 주소 범위



예를 들어, MetalLB에게 `192.168.10.0/24` 주소와 `64500` 의 AS 번호를 지정하고 AS 번호 `64501` 을 사용하여 `10.0.0.1` 의 라우터에 연결하려는 경우 다음과 같이 구성할 수 있다.

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: metallb-system
  name: config
data:
  config: |
    peers:
    - peer-address: 10.0.0.1
      peer-asn: 64501
      my-asn: 64500
    address-pools:
    - name: default
      protocol: bgp
      addresses:
      - 192.168.10.0/24
```





## Issues with Calico



























