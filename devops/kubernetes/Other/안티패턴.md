# K8S 안티패턴

인터넷에서 수집한 쿠버네티스 안티패턴에 대해 정리해보았다. 아래 소개된 안티패턴은 최대한 지양하자.

https://codefresh.io/kubernetes-tutorial/kubernetes-antipatterns-1/



1. 쿠버네티스 디플로이먼트에 `latest` 태그 사용.
2. 구성 데이터를 컨테이너 이미지 내부에 위치.
3. 아무 이유 없이 쿠버네티스 feature/service와 애플리케이션 결합
4. 애플리케이션 디플로이먼트와 인프라스트럭처 디플로이먼트를 혼합 (Helm 프로바이더와 함께 Terraform이 애플리케이션을 배포)
5. 수동으로 kubectl edit/patch로 임시 배포 수행
6. kubectl을 디버깅 툴로 사용
7. 쿠버네티스 네트워크 개념에 대한 오해
8. 동적 환경 대신 영구 스테이징 환경 사용
9. 프로덕션 클러스터와 비프로덕션 클러스터 혼합
10. 메모리와 CPU limit을 두지 않고 배포
11. Health probes 오용
12. Helm 미사용
13. 애플리케이션이 수행하는 작업을 이해하기 위한 배포 메트릭 없음
14. 시크릿 전략이 없거나 시크릿을 임시로 취급
15. 쿠버네티스에서 모든 것을 시도 (DB 및 상태 저장 포함)



## 1. 쿠버네티스 디플로이먼트에 `latest` 태그 사용

먼저 latest 태그는 실제 버전 확인이 어렵다. (CI 시스템 로그를 봐야하거나 이미지를 로컬에서 다운로드 받아서 확인해야 함.)

그리고 image pull policy가 `Always`로 되어있으면 위험하다. 파드가 띄워지고 난 후 최신 이미지가 변경된 다음에 파드가 죽고 다시 살아날 때 변경된 최신 이미지가 배포되기 때문에 기존에 살아있는 파드와 다른 이미지를 사용하는 문제가 발생한다.

태그에 대한 몇가지 추천 방법이 있다.

* Git hash를 이용하여 태깅한다. ( `docker.io/myusername/my-app:acef3e`)
* 애플리케이션 버전을 태그에 명시한다. (`docker.io/myusername/my-app:v1.0.1`)



## 2. 구성 데이터를 컨테이너 이미지 내부에 위치.

컨테이너 이미지는 `일반적`이어야 한다. (어떤 환경에서든 잘 돌아가야 한다는 뜻) 그러기 위해서는 컨테이너 자체에 구성이 없어야 한다. 

만약 컨테이너 이미지에서 다음 구성이 있다면 다른 환경에서 에러나기 쉽다.

* 하드코딩된 IP 주소
* 패스워드와 시크릿 포함
* 다른 서비스와 통신하기 위한 특정 URL



실행 중인 환경에 영향을 받지 않는 일반 컨테이너 이미지를 만든 후 환경에 대한 구성에 대해서는 쿠버네티스 `ConfigMap`, `Hashicorp Consul`, `Apache Zookeeper` 등을 사용하자.



## 7. 쿠버네티스 네트워크 개념에 대한 오해

예전에는 하나의 단일 로드밸런서가 애플리케이션에 필요한 모든 것이었다. 쿠버네티스는 자신의 네트워킹 모델을 소개하였고 해당 네트워킹 모델에 대한 주요 개념을 이해하고 배우는 것이 필요하다. 최소한 LoadBalancer, ClusterIP, NodePort 및 Ingress에 대한 차이점을 잘 알고 있어야 한다.

조직에서 중량이 큰 단일 인그레스 컨트롤러를 사용하여 과도한 설정을 생성하는 경우도 있고 여러 로드밸런서를 두는 경우도 있다.

다양한 서비스 옵션을 이해하는 것은 쿠버네티스 네트워킹을 시작하는 사람들에게는 가장 혼란스러운 측면 중 하나이다. ClusterIP 서비스는 클러스터 내부에서만 사용 가능하며 NodePort는 클러스터 내부와 외부 둘 다 사용 가능하고 LoadBalancer는 클러스터 외부에서 사용 가능하다. 따라서 각 서비스 유형의 의미를 이해해야 한다.

그리고 서비스는 클러스터 내부의 트래픽을 얻기 위함이다. 그래서 클러스터 내부에서 트래픽이 작동하는 방식에 대해 주의를 기울여야 한다. DNS, Security certificates, Virtual Service는 쿠버네티스 프로덕션 클러스터에 대해 자세히 처리해야 하는 모든 측면이다.









## 15. 쿠버네티스에서 모든 것을 시도

쿠버네티스는 특정 문제들을 해결하는 솔루션이다. 이러한 문제가 이미 있는 경우, 쿠버네티스를 채택하려면 워크플로우가 크게 간소화되고 잘 설계되고 유지관리되는 클러스터링 솔루션에 접근할 수 있다. 그러나 쿠버네티스를 채택하는 것에 대한 이점과 단점을 이해하는 것이 중요하다. 

처음에는 클러스터의 탄력성과 확장성을 활용하는 stateless 서비스에 쿠버네티스를 사용하는 것은 훨씬 쉽다. 쿠버네티스가 기술적으로 stateful service도 지원하기는 하지만, 마이그레이션을 시작할 때는 클러스터 외부에서 stateful service를 실행하는 것이 좋다. 데이터베이스, 캐싱 솔루션, 아티팩트 레포지토리와 도커 레지스트리 등을 클러스터 밖에 유지하는 것도 좋다.

